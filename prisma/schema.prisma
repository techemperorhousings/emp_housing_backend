// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - base for all user types
model User {
  id                        String    @id @default(uuid())
  email                     String    @unique
  password                  String
  firstname                 String
  lastname                  String
  username                  String    @unique
  phoneNumber               String?   @unique
  profileImage              String?
  resetRequest              String?
  verified                  Boolean   @default(false)
  kycVerified               Boolean   @default(false)
  verifyToken               String?
  verifyTokenExpires        DateTime?
  resetPasswordToken        String?
  resetPasswordTokenExpires DateTime?
  KYC                       KYC?
  isActive                  Boolean   @default(true)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  // Relations
  propertiesOwned            Property[]        @relation("PropertyOwner")
  listings                   Listing[]
  bookings                   PropertyBooking[]
  rentalAgreementsAsTenant   RentalAgreement[] @relation("Tenant")
  rentalAgreementsAsLandlord RentalAgreement[] @relation("Landlord")
  purchasesAsBuyer           Purchase[]        @relation("Buyer")
  purchasesAsSeller          Purchase[]        @relation("Seller")
  favorites                  Favorite[]

  offers            Offer[]            @relation("BuyerOffers")
  reviews           Review[]           @relation("UserReviews")
  tickets           SupportTicket[]
  assignedTickets   SupportTicket[]    @relation("AssignedTickets")
  ticketMessages    TicketMessage[]
  ticketAttachments TicketAttachment[]
  kycReviews        KYC[]              @relation("KycReviews")

  requestedTours PropertyTour[]  @relation("TourRequester")
  conductedTours PropertyTour[]  @relation("TourAgent")
  Permission     Permission?     @relation(fields: [permissionId], references: [id])
  permissionId   String?
  role           Role?           @relation(fields: [roleId], references: [id])
  roleId         String?
  Notifications  Notifications[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

model KYC {
  id           String          @id @default(uuid())
  userId       String          @unique
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentType KycDocumentType
  documentUrl  String // Link to uploaded KYC document
  status       KycStatus       @default(PENDING)
  reason       String?
  reviewerId   String? // ID of the admin who reviewed this KYC
  reviewer     User?           @relation("KycReviews", fields: [reviewerId], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

model Property {
  id          String         @id @default(uuid())
  title       String
  description String
  price       Decimal
  // @db.Decimal(10,2)
  location    String
  type        PropertyType
  status      PropertyStatus @default(PENDING)
  ownerId     String
  owner       User           @relation("PropertyOwner", fields: [ownerId], references: [id])
  isActive    Boolean        @default(false)

  // Address fields
  street          String
  nearestLandMark String
  city            String
  state           String
  zipCode         String
  country         String
  address         String

  // Property details
  bedrooms  Int
  bathrooms Int
  area      Float // in square feet/meters
  yearBuilt Int?

  // Relations
  features        Feature[]
  images          PropertyImage[]
  documents       PropertyDocument[]
  listings        Listing[]
  purchases       Purchase[]
  tours           PropertyTour[]
  reviews         Review[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  PropertyBooking PropertyBooking[]
  favorites       Favorite[]
  tickets         SupportTicket[]
}

model PropertyDocument {
  id         String   @id @default(uuid())
  name       String
  url        String
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploadedAt DateTime @default(now())
}

model Feature {
  id          String   @id @default(uuid())
  name        String
  count       Int      @default(1)
  description String?
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model PropertyImage {
  id         String   @id @default(uuid())
  url        String
  isFeatured Boolean  @default(false)
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploadedAt DateTime @default(now())
}

model Listing {
  id          String        @id @default(uuid())
  propertyId  String
  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  listedById  String
  listedBy    User          @relation(fields: [listedById], references: [id], onDelete: Restrict)
  price       Decimal       @db.Decimal(10, 2)
  isActive    Boolean       @default(true)
  status      ListingStatus @default(PENDING)
  listingType ListingType
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  rentals   RentalAgreement[]
  purchases Purchase[]
  offers    Offer[]
  tours     PropertyTour[]
  bookings  PropertyBooking[]
  tickets   SupportTicket[]

  @@index([propertyId])
  @@index([listedById])
  @@index([status])
}

model PropertyBooking {
  id              String        @id @default(uuid())
  checkInDate     DateTime
  checkoutDate    DateTime
  requestMessage  String?
  responseMessage String?
  status          BookingStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  propertyId      String
  property        Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Restrict)
  listingId       String
  listing         Listing          @relation(fields: [listingId], references: [id], onDelete: Cascade)
  RentalAgreement RentalAgreement?

  @@index([propertyId])
  @@index([userId])
  @@index([listingId])
  @@index([status])
}

model RentalAgreement {
  id            String       @id @default(uuid())
  startDate     DateTime
  endDate       DateTime
  amount        Decimal      @db.Decimal(10, 2)
  depositAmount Decimal      @db.Decimal(10, 2)
  isActive      Boolean      @default(false)
  isPaid        Boolean      @default(false)
  status        RentalStatus @default(PENDING)
  termsAccepted Boolean      @default(false)
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  bookingId String?          @unique
  booking   PropertyBooking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  tenantId String
  tenant   User   @relation(name: "Tenant", fields: [tenantId], references: [id], onDelete: Restrict)

  landlordId String
  landlord   User   @relation(name: "Landlord", fields: [landlordId], references: [id], onDelete: Restrict)

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Restrict)

  payments RentalPayment[]

  @@unique([tenantId, listingId, isActive])
  @@unique([landlordId, listingId, isActive])
  @@index([tenantId])
  @@index([landlordId])
  @@index([listingId])
  @@index([status])
}

model RentalPayment {
  id            String    @id @default(uuid())
  amount        Decimal   @db.Decimal(10, 2)
  dueDate       DateTime?
  paymentDate   DateTime?
  isPaid        Boolean   @default(false)
  paymentMethod String?
  transactionId String?   @unique
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  rentalAgreementId String
  rentalAgreement   RentalAgreement @relation(fields: [rentalAgreementId], references: [id], onDelete: Cascade)

  @@index([rentalAgreementId])
  @@index([dueDate])
  @@index([isPaid])
}

model Purchase {
  id            String         @id @default(uuid())
  purchaseDate  DateTime
  amount        Decimal        @db.Decimal(10, 2)
  status        PurchaseStatus @default(PENDING)
  notes         String?
  transactionId String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Restrict)
  buyerId   String
  buyer     User    @relation(name: "Buyer", fields: [buyerId], references: [id], onDelete: Restrict)

  sellerId   String
  seller     User      @relation(name: "Seller", fields: [sellerId], references: [id], onDelete: Restrict)
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: Restrict)

  @@unique([listingId, buyerId, sellerId])
  @@index([listingId])
  @@index([buyerId])
  @@index([status])
}

model PropertyTour {
  id              String     @id @default(uuid())
  scheduledDate   DateTime
  scheduledTime   String
  tourType        TourType // Virtual or In-Person
  status          TourStatus @default(PENDING)
  notes           String?    @db.Text
  feedback        String?    @db.Text // For feedback after the tour
  meetingLink     String? // For virtual tours, store the meeting URL
  meetingPassword String? // Optional password for virtual meetings
  location        String? // For in-person tours, could be property address or specific meeting point
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  requestedById String
  requestedBy   User   @relation(name: "TourRequester", fields: [requestedById], references: [id], onDelete: Restrict)

  agentId String?
  agent   User?   @relation(name: "TourAgent", fields: [agentId], references: [id], onDelete: SetNull)

  @@unique([requestedById, propertyId])
  @@index([propertyId])
  @@index([listingId])
  @@index([requestedById])
  @@index([agentId])
  @@index([status])
  @@index([scheduledDate])
}

model Offer {
  id        String      @id @default(uuid())
  amount    Float
  status    OfferStatus @default(PENDING)
  message   String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  buyerId String
  buyer   User   @relation(name: "BuyerOffers", fields: [buyerId], references: [id], onDelete: Restrict)

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id])
}

model Review {
  id        String   @id @default(uuid())
  rating    Int
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(name: "UserReviews", fields: [userId], references: [id], onDelete: Cascade)

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id])

  @@unique([userId, propertyId])
}

model Favorite {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId]) // Prevents users from favoriting the same property multiple times
}

model SupportTicket {
  id          String         @id @default(uuid())
  subject     String
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    String // e.g., "Technical Issue", "Listing Problem", "Account Help"
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  closedAt    DateTime?
  userId      String
  user        User           @relation(fields: [userId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("AssignedTickets", fields: [assignedToId], references: [id])

  propertyId String? // Optional: Related to a specific property
  property   Property? @relation(fields: [propertyId], references: [id])

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  messages    TicketMessage[]
  attachments TicketAttachment[]
}

model TicketMessage {
  id           String        @id @default(uuid())
  message      String
  createdAt    DateTime      @default(now())
  isStaffReply Boolean       @default(false)
  ticketId     String
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model TicketAttachment {
  id        String   @id @default(uuid())
  filename  String
  fileUrl   String
  createdAt DateTime @default(now())

  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model Permission {
  id             String           @id @default(uuid())
  name           String
  role           String
  access         String
  status         APP_STATUS       @default(ACTIVE)
  RolePermission RolePermission[]
  users          User[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  permissions RolePermission[]
  users       User[]
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model Notifications {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String
  type      String? // e.g., "ORDER_STATUS", "PROMOTION", "SYSTEM"
  data      Json?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Message {
  id          String   @id @default(uuid())
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isRead      Boolean  @default(false)
  
  // Relations
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  
  receiverId  String
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

enum APP_STATUS {
  ACTIVE
  INACTIVE
  PENDING
  SUSPENDED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_USER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TourType {
  VIRTUAL
  IN_PERSON
}

enum TourStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
  NO_SHOW
  RESHEDULED
}

enum ListingStatus {
  ACTIVE
  PENDING
  SOLD
  RENTED
  EXPIRED
  CANCELLED
}

enum ListingType {
  FOR_SALE
  FOR_RENT
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  CONVERTED_TO_RENTAL
}

enum RentalStatus {
  PENDING
  ACTIVE
  TERMINATED
  EXPIRED
}

enum PurchaseStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum KycDocumentType {
  NATIONAL_ID
  PASSPORT
  DRIVERS_LICENSE
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  USER
  ADMIN
  SUPERADMIN
  SUPPORT_STAFF
}

enum PropertyStatus {
  AVAILABLE
  PENDING
  SOLD
  LEASED
  OFF_MARKET
}

enum PropertyType {
  HOUSE
  APARTMENT
  CONDO
  TOWNHOUSE
  LAND
  COMMERCIAL
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}
